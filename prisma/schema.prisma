// =============================================================================
// Prisma Schema - Astro NFT Marketplace
// =============================================================================
// Run `npx prisma migrate dev` to create migration
// Run `npx prisma generate` to create Prisma Client
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// =============================================================================
// User & Wallet
// =============================================================================
model User {
  id       String  @id @default(uuid())
  username String?
  bio      String?
  avatar   String?
  role     String  @default("USER")

  wallets Wallet[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  nfts      Nft[]

  @@map("users")
}

model Wallet {
  address String  @id
  userId  String?
  user    User?   @relation(fields: [userId], references: [id])

  nonce     String?
  createdAt DateTime @default(now())

  @@map("wallets")
}

// =============================================================================
// Collection
// =============================================================================
model Collection {
  id              String @id @default(uuid())
  contractAddress String @unique
  chainId         Int
  standard        String // ERC721 | ERC1155

  name        String?
  symbol      String?
  description String?
  imageUrl    String?

  creatorAddress String
  royaltyFee     Int // basis points

  createdAt DateTime @default(now())

  nfts     Nft[]
  editions Edition[]
  drops    Drop[]

  @@map("collections")
}

// =============================================================================
// NFT
// =============================================================================
model Nft {
  id              String @id @default(uuid())
  contractAddress String
  tokenId         String
  chainId         Int

  ownerAddress   String
  creatorAddress String

  metadataUri String
  imageUrl    String?
  name        String?
  description String?

  collectionId String
  collection   Collection @relation(fields: [collectionId], references: [id])

  createdAt DateTime @default(now())
  user      User?    @relation(fields: [userId], references: [id])
  userId    String?

  @@unique([contractAddress, tokenId])
  @@index([ownerAddress])
  @@map("nfts")
}

// =============================================================================
// Edition
// =============================================================================
model Edition {
  id              String @id @default(uuid())
  contractAddress String
  tokenId         String
  chainId         Int

  creatorAddress String
  totalSupply    Int

  metadataUri String
  name        String?
  imageUrl    String?

  collectionId String
  collection   Collection @relation(fields: [collectionId], references: [id])

  balances EditionBalance[]

  createdAt DateTime @default(now())

  @@unique([contractAddress, tokenId])
  @@map("editions")
}

// =============================================================================
// Edition Balance
// =============================================================================
model EditionBalance {
  id        String @id @default(uuid())
  editionId String
  owner     String
  balance   Int

  edition Edition @relation(fields: [editionId], references: [id])

  @@unique([editionId, owner])
  @@map("edition_balances")
}

// =============================================================================
// Drop
// =============================================================================
model Drop {
  id           String     @id @default(uuid())
  collectionId String
  collection   Collection @relation(fields: [collectionId], references: [id])

  assetType String // NFT | EDITION
  tokenId   String?

  price     Decimal  @db.Decimal(36, 18)
  maxSupply Int?
  startTime DateTime
  endTime   DateTime

  createdAt DateTime @default(now())

  @@map("drops")
}

// =============================================================================
// Marketplace & Sales
// =============================================================================
model Listing {
  id              String  @id @default(uuid())
  contractAddress String
  tokenId         String
  sellerAddress   String
  price           Decimal @db.Decimal(36, 18)
  isActive        Boolean @default(true)

  createdAt DateTime @default(now())

  @@index([contractAddress, tokenId])
  @@map("listings")
}

model Sale {
  id              String  @id @default(uuid())
  contractAddress String
  tokenId         String
  seller          String
  buyer           String
  price           Decimal @db.Decimal(36, 18)

  txHash      String
  blockNumber Int
  timestamp   DateTime

  @@map("sales")
}
